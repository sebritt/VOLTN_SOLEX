<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VOLT'N SOLEX</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100%; }
    /* Popup Modal */
    #modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
    }
    #info, #terminal, #slider {
      position: fixed;
      background: white;
      padding: 10px;
      border: 2px solid black;
      border-radius: 5px;
      font-family: monospace;
      z-index: 999;
    }
    #info { bottom: 10px; left: 10px; white-space: pre-wrap; max-width: 40%; }
    #terminal { bottom: 10px; right: 10px; background: black; color: lime; width: 40%; height: 100px; overflow-y: auto; }
    #slider { top: 10px; left: 10px; display: none; }
    #Clear {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #Clear:hover {
      background-color: #f0f0f0;
    }
    #alert-speed {
      position: fixed;
      top: 10px;
      right: 60px; /* √† c√¥t√© du bouton de refresh */
      z-index: 1001;
      background-color: red;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-weight: bold;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="modal">
    <div id="modal-content">
      <h3>Choisir une source GPS</h3>
      <div>
        <label>Port s√©rie :</label>
        <select id="port-select"></select>
        <button onclick="startSerial()">D√©marrer</button>
      </div>
      <hr>
      <div>
        <label>Fichier CSV :</label>
        <input type="file" id="csvfile">
        <button onclick="uploadCSV()">Charger</button>
      </div>
    </div>
  </div>
  

  <div id="map"></div>
  <div id="alert-speed">‚ö†Ô∏è Vitesse √©lev√©e d√©tect√©e !</div>
  <button id="Clear" onclick="location.reload()">üîÑ</button>
  <div id="info">En attente...</div>
  <div id="slider">
    <label for="range">Temps: <span id="timeVal">--:--</span></label><br>
    <input type="range" id="range" min="0" max="0" value="0">
  </div>
  <div id="terminal">Terminal...</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let trail = [], polylines = [], allData = [], currentMarker = null, currentLatLng = null, lastIndex = -1;

    const map = L.map('map').setView([48.0, -1.0], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

    function formatTime(ms) {
      const min = Math.floor(ms / 60000), sec = Math.floor((ms % 60000) / 1000);
      return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    const updateLive = async () => {
      const res = await fetch('/data');
      const [data] = await res.json();
      if (!data.lat || !data.lon) return;

      const lat = data.lat, lon = data.lon, speed = data.speed;
      currentLatLng = [lat, lon];

      // Rotation des images
      const gyroY = data.gyro_y || 0;
      document.getElementById("face-img").style.transform = `rotate(${gyroY}deg)`;
      const gyroMatch = data.formatted.match(/gyro_x\s*:\s*([-\d.]+)/);
      if (gyroMatch) {
        const gyroX = parseFloat(gyroMatch[1]);
        const profilImg = document.getElementById('profil-img');
        if (profilImg) {
          profilImg.style.transform = `rotate(${gyroX}deg)`;
        }
      }

      // Alerte vitesse
      document.getElementById('alert-speed').style.display = (speed > 90) ? 'block' : 'none';

      if (trail.length > 0) {
        const prev = trail[trail.length - 1];
        polylines.push(L.polyline([[prev[0], prev[1]], [lat, lon]], { color: 'blue' }).addTo(map));
      }
      trail.push([lat, lon, speed]);
      if (currentMarker) map.removeLayer(currentMarker);
      currentMarker = L.circleMarker([lat, lon], { radius: 6, color: 'red', fillOpacity: 1.0 }).addTo(map);
      map.panTo([lat, lon]);
      document.getElementById('info').innerText = data.formatted;
    };


    const drawCSV = idx => {
      if (idx === lastIndex) return;
      if (idx > lastIndex) {
        for (let i = lastIndex + 1; i <= idx; i++) {
          const pt = allData[i];
          trail.push([pt.lat, pt.lon, pt.speed]);
          if (trail.length > 1) {
            const prev = trail[trail.length - 2];
            polylines.push(L.polyline([[prev[0], prev[1]], [pt.lat, pt.lon]], { color: 'green' }).addTo(map));
          }
        }
      } else {
        for (let i = lastIndex; i > idx; i--) {
          map.removeLayer(polylines.pop());
          trail.pop();
        }
      }
      const last = allData[idx];
      currentLatLng = [last.lat, last.lon];
      if (currentMarker) map.removeLayer(currentMarker);
      currentMarker = L.circleMarker(currentLatLng, { radius: 6, color: 'red' }).addTo(map);
      document.getElementById('info').innerText = last.formatted;
      document.getElementById('timeVal').innerText = formatTime(last.millis);
      map.panTo(currentLatLng);
      lastIndex = idx;

      if (last.speed > 120) {
        document.getElementById('alert-speed').style.display = 'block';
      } else {
        document.getElementById('alert-speed').style.display = 'none';
      }
    };

    const startSerial = async () => {
      const port = document.getElementById("port-select").value;
      const res = await fetch("/live", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ port })
      });
      if (res.ok) {
        document.getElementById("modal").style.display = "none";
        setInterval(updateLive, 500);
      }
    };

    const uploadCSV = async () => {
      const fileInput = document.getElementById("csvfile");
      const formData = new FormData();
      formData.append("csvfile", fileInput.files[0]);
      const res = await fetch("/upload", { method: "POST", body: formData });
      if (res.ok) {
        const d = await fetch("/data");
        allData = await d.json();
        const slider = document.getElementById("range");
        slider.max = allData.length - 1;
        slider.value = allData.length - 1;
        document.getElementById("slider").style.display = "block";
        slider.oninput = e => drawCSV(parseInt(e.target.value));
        drawCSV(allData.length - 1);
        document.getElementById("modal").style.display = "none";
      }
    };

    const loadPorts = async () => {
      const res = await fetch("/ports");
      const ports = await res.json();
      const select = document.getElementById("port-select");
      select.innerHTML = "";
      ports.forEach(port => {
        const opt = document.createElement("option");
        opt.value = port;
        opt.textContent = port;
        select.appendChild(opt);
      });
    };

    loadPorts();

    setInterval(async () => {
      const res = await fetch("/line_raw");
      document.getElementById('terminal').innerText = await res.text();
    }, 500);
  </script>
  <img id="face-img" src="/static/images/face.png" style="position: fixed; bottom: 115px; right: 10px; width: 80px; height: auto; transform: rotate(0deg); transition: transform 0.2s linear; z-index: 1000;" />
  <img id="profil-img" src="/static/images/profil.png" style="position: fixed; bottom: 120px; right: 100px; width: 100px; height: auto; transform: rotate(0deg); transition: transform 0.2s linear; z-index: 1001;"/>
</body>
</html>
